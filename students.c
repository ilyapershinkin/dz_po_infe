#include "header.h"void Students_exit(struct Student *Students, int LineCount){    printf("Save state...\n");    FILE *StudentsFile=fopen(students_csv, "w");    check_fopen(StudentsFile, students_csv);        for(int i=0; i<LineCount;i++){        if (strcmp("NULL", Students[i].RecBook)!=0){            fprintf(StudentsFile,"%s;%s;%s;%s;%s;%s",Students[i].RecBook,Students[i].SName,Students[i].Name,Students[i].OName,Students[i].Faculty,Students[i].Spec);            if(i!=LineCount-1) {fprintf(StudentsFile,"\n");}        }    }    fclose(StudentsFile);    printf("Save successful\n");    getchar();    free(Students);    return ;}struct Student *Students_add(struct Student *Students, int LineCount){    _Bool Error = 0;    while(!Error){        printf("Enter Student's record book: ");        char RecBook[10];        scanf("%s",RecBook);        getchar();        _Bool err = 0;        while(!err){            int j=0;            while(RecBook[j] != '\0') {j++;}            if(j == 6 || j == 7){                err=1;            } else {                printf("Enter VALID Student's record book: ");                for(int i = 0; i<10; i++){                    RecBook[i] = 0;                }                scanf("%s",RecBook);            }        }        int choice = -1;        for(int i=0; i<LineCount; i++) {            if(strcmp(RecBook, Students[i].RecBook)==0){                while(choice != 1){                    p_err("This student is already exist"); printf("0 - for exit, 1 - for retry\n");                    scanf("%d", &choice);                    if(choice == 0){                        return NULL;                    } else if (choice != 1){                         p_err("\nEnter correct command\n");                    }                }            }        }        if (!Error) {            printf("Enter name:");            char Name[128];            strcpy(Name, scan('\n'));                        printf("Enter surname:");            char SName[128];            strcpy(SName, scan('\n'));                        printf("Enter patronymic:");            char OName[128];            strcpy(OName, scan('\n'));                        printf("Enter faculty: ");            char Faculty[128];            strcpy(Faculty, scan('\n'));                        printf("Enter specialty:");            char Spec[128];            strcpy(Spec, scan('\n'));                        LineCount++;            Students=(struct Student*)realloc(Students ,(LineCount)*sizeof(struct Student));            strcpy(Students[LineCount-1].RecBook,RecBook);            strcpy(Students[LineCount-1].SName,SName);            strcpy(Students[LineCount-1].Name,Name);            strcpy(Students[LineCount-1].OName,OName);            strcpy(Students[LineCount-1].Faculty,Faculty);            strcpy(Students[LineCount-1].Spec,Spec);            printf("\nStudent add successful!\n");            return Students;        }    }    return Students;}void Students_delete(struct Student *Students, int LineCount){    printf("Enter Student's record book: ");    char RecBook[10];    scanf("%s",RecBook);    _Bool err = 0;    while(!err){        int j=0;        while(RecBook[j] != '\0') {j++;}        if(j == 6 || j == 7){            err=1;        } else {            printf("Enter VALID Student's record book: ");            for(int i = 0; i<10; i++){                RecBook[i] = 0;            }            scanf("%s",RecBook);        }    }    printf("Searching student...\n");    int i=0; int BookLine=-1;    for(i=0; i<=LineCount; i++) {        if(strcmp(RecBook, Students[i].RecBook)==0){            printf("Student found...\n"); BookLine=i; break;        }    }    if (BookLine==-1){        printf("Student not found.\nPress enter to leave...\n");        getchar();getchar();    } else{                FILE *SBFile=fopen(student_books_csv, "r");        if (SBFile==NULL){            notify("e", "StudentBooksCsvMissing", 0, student_books_csv, 1);            p_err("File with students cannot be open");        }else{            int SBLineCount=0;            while(! feof(SBFile)){                if (fgetc(SBFile)=='\n')                    SBLineCount++;            }            SBLineCount++;            fclose(SBFile);                        char Buff[1024];            SBFile=fopen(student_books_csv, "r");            int BooksTrigger=0;            for (i=0; i<SBLineCount-1;i++){                fgets(Buff, 1024,SBFile);                char RecBook[10];                strtok(Buff,";");                strcpy(RecBook,strtok(NULL,";"));                if (strcmp(RecBook,Students[BookLine].RecBook)==0){                    BooksTrigger=1;                    break;                }            }            fclose(SBFile);                        if (BooksTrigger==0){                strcpy(Students[BookLine].RecBook,"NULL");                printf("Student delete successful!\nPress enter to leave...\n");                getchar();            } else {                p_err("This student have non return books.\nPress enter to leave...\n");            }            getchar();getchar();        }    }}void Students_backup_save(struct Student *Students, int LineCount){    char Way[64]=backup_derictory;    char Time[32] = {0};    long int s_time = time(NULL);    struct tm *m_time = localtime(&s_time);    strftime(Time, 32, "%d-%m-%Y(%H.%M.%S)", m_time);    strcat(Way,"students_");    strcat(Way,Time);    strcat(Way,".csv");    FILE *BackFile=fopen(Way, "w");    if (BackFile==NULL){        notify("e", "BackupFileCreateFail", 0, Way, 1);        p_err("File cannot be create");    }    for(int i=0; i<LineCount; i++){        fprintf(BackFile,"%s;%s;%s;%s;%s;%s",Students[i].RecBook,Students[i].SName,Students[i].Name,Students[i].OName,Students[i].Faculty,Students[i].Spec);    }    fclose(BackFile);    printf("Save successful\n");    printf("Flie name: %s\n", Way);    printf("Please, do not rename file\n");    printf("Press enter to leave...\n");    getchar();getchar();}struct Student *Students_backup_upload(struct Student *Students, int LineCount, FILE *StudentsFile){    char Buff[1024] = {0};    printf("Enter backup file derictory: ");    char Way[64];    scanf("%s",Way);    _Bool NonValidFile = 1;    int i=4;    while(Way[i] != '\0'){        if(Way[i-3] == '.' && Way[i-2] == 'c' && Way[i-1] == 's' && Way[i] == 'v'){            NonValidFile = 0;        }        i++;    }    if(NonValidFile){        char text[64] = {0};        strcat(text, "ls ./");        strcat(text, backup_derictory);        strcat(text, " | grep '.csv' | grep 'students'");        p_err("This is not 'csv' file... There mind be your file:");        system(text);        return Students;    }    FILE *BackFile=fopen(Way, "r");    if (BackFile==NULL){        char Way2[64] = backup_derictory;        strcat(Way2, Way);        for(int j=0; j<64; j++){            Way[j] = 0;        }        strcat(Way, Way2);                BackFile=fopen(Way, "r");        if(BackFile==NULL){            notify("e", "BackupFileCsvMissing", 0, Way, 1);            p_err("Backup file cannot be open");            return Students;        }    }        LineCount=0;    while(! feof(BackFile)){        if (fgetc(BackFile)=='\n')            LineCount++;    }    LineCount++;    fclose(BackFile);    FILE *BackFile2 = fopen(Way, "r");    struct Student *Students_upload;    Students_upload=(struct Student*)malloc(sizeof(struct Student));    for (i=0; i<LineCount;i++){        fgets(Buff, 1024,BackFile2);        strcpy(Students_upload[i].RecBook,strtok(Buff,";"));        strcpy(Students_upload[i].SName,strtok(NULL,";"));        strcpy(Students_upload[i].Name,strtok(NULL,";"));        strcpy(Students_upload[i].OName,strtok(NULL,";"));        strcpy(Students_upload[i].Faculty,strtok(NULL,";"));        strcpy(Students_upload[i].Spec,strtok(NULL,";"));        Students_upload=(struct Student*)realloc(Students_upload ,(i+2)*sizeof(struct Student));    }    fclose(BackFile2);    FILE *StudentFile=fopen(students_csv, "w");    if (StudentFile==NULL){        notify("e", "StudentsCsvMissing", 0, students_csv, 1);        p_err("Students file cannot be open, upload save in RAM");    } else {        for(i=0; i<LineCount;i++){            if (strcmp("NULL", Students_upload[i].RecBook)!=0){                fprintf(StudentsFile,"%s;%s;%s;%s;%s;%s",Students_upload[i].RecBook,Students_upload[i].SName,Students_upload[i].Name,Students_upload[i].OName,Students_upload[i].Faculty,Students_upload[i].Spec);            }            if(i!=LineCount-1){                fprintf(StudentsFile,"\n");            }        }        fclose(StudentsFile);        printf("Backup uploaded\nRestart library...\n");    }    free(Students);    return Students_upload;}void Students_search(struct Student *Students, int LineCount){    printf("Enter Student's surname: ");    char SName[128];    scanf("%s",SName);    printf("Search srudent...\n");    int i=0; int BookLine=-1;    for (i=0;i<=LineCount;i++){        if(strcmp(SName, Students[i].SName)==0){            BookLine=i;            printf("\n%s %s %s\nRecord book: %s\nFaculty: %s\nSpecialty:  %s\n",Students[i].SName,Students[i].Name,Students[i].OName,Students[i].RecBook,Students[i].Faculty,Students[i].Spec);            printf("\nPress enter to leave...\n");            getchar();getchar();        }    }    if(BookLine==-1){        printf("Student not found.\nPress enter to leave...\n");        getchar();getchar();    }}void Students_showall(struct Student *Students, int LineCount){    printf("Enter Student's record book: ");    char RecBook[10];    scanf("%s",RecBook);    _Bool err = 0;    while(!err){        int j=0;        while(RecBook[j] != '\0') {j++;}        if(j == 6 || j == 7){            err=1;        } else {            printf("Enter VALID Student's record book: ");            for(int i = 0; i<10; i++){                RecBook[i] = 0;            }            scanf("%s",RecBook);        }    }        printf("Searching student...\n");    int i=0; int BookLine=-1;    for(i=0; i<LineCount; i++) {        if(strcmp(RecBook, Students[i].RecBook)==0){            printf("Student found...\n");BookLine=i; break;        }    }    if (BookLine==-1){ printf("Student not found.\nPress enter to leave...\n");        getchar();getchar();    } else {        FILE *SBFile=fopen(student_books_csv, "r");        if (SBFile==NULL){            notify("e", "StudentsBooksCsvMissing", 0, student_books_csv, 1);            p_err("File with students cannot be open");        }        else{            int SBLineCount=0;            while(! feof(SBFile)){                if (fgetc(SBFile)=='\n')                    SBLineCount++;            }            fclose(SBFile);                        char Buff[1024];            SBFile=fopen(student_books_csv, "r");            long long *ArrIISBN;            if(LineCount == 0){                notify("e", "Students", 34, "LineCount=0", 0);            }            if(SBLineCount == 0){                notify("e", "Students", 34, "SBLineCount=0", 0);                exit(0); //for debuger. there is no sense            }                        char Date[SBLineCount][20];            int ArrCounter=0;            ArrIISBN=(long long*)malloc(sizeof(long long));            for (i=0; i<SBLineCount;i++){                fgets(Buff, 1024,SBFile);                char RecBook[10];                long long IISBN;                char CheckDate[20];                IISBN=atoll(strtok(Buff,";"));                strcpy(RecBook,strtok(NULL,";"));                strcpy(CheckDate,strtok(NULL,";"));                if (strcmp(RecBook,Students[BookLine].RecBook)==0){                    ArrIISBN=(long long*)realloc(ArrIISBN ,(ArrCounter+2)*sizeof(long long));                    ArrIISBN[ArrCounter]=IISBN;                    strcpy(Date[ArrCounter],CheckDate);                    ArrCounter++;                }            }            fclose(SBFile);                        if (ArrCounter==0){                printf("This student dont have books.\n");            }            else{                FILE *BookFile1=fopen(books_csv, "r");                                if (BookFile1==NULL){                    notify("e", "BooksCsvMissing", 0, books_csv, 1);                    p_err("File with students cannot be open");                } else {                                        int BLineCount=0;                    while(! feof(BookFile1)){                        if (fgetc(BookFile1)=='\n')                            BLineCount++;                    }                    fclose(BookFile1);                                        BookFile1=fopen(books_csv, "r");                    printf ("Books on hand:\n\n");                    for (i=0; i<BLineCount;i++){                        fgets(Buff, 1024,BookFile1);                        long long IISBN;                        IISBN=atoll(strtok(Buff,";"));                        int k=0;                        for (k=0; k<=ArrCounter;k++){                            if(ArrIISBN[k]==IISBN) printf("%lli\nName: %s\nAuthor: %s\nReturn Date: %s\n",IISBN,strtok(NULL,";"),strtok(NULL,";"), Date[k]);                        }                    }                    fclose(BookFile1);                                    }            }            free(ArrIISBN);        }    }    printf("Press enter to leave...\n");    getchar();getchar();}void Students_start(void){    char Buff[1024];    int Command=-11;    FILE *StudentsFile=fopen(students_csv, "r");    check_fopen(StudentsFile, students_csv);        int LineCount = 0;    while(!feof(StudentsFile)){        if (fgetc(StudentsFile)=='\n'){            LineCount++;        }    }    if(LineCount == 0){        notify("e", "Students", 34, "LineCount=0", 0);        exit(0); //for debuger. there is no sense    }    fclose(StudentsFile);        struct Student *Students;    Students=(struct Student*)malloc(sizeof(struct Student));    int i=0;    StudentsFile=fopen(students_csv, "r");    for (i=0; i<LineCount;i++){        fgets(Buff, 1024,StudentsFile);        strcpy(Students[i].RecBook,strtok(Buff,";"));        strcpy(Students[i].SName,strtok(NULL,";"));        strcpy(Students[i].Name,strtok(NULL,";"));        strcpy(Students[i].OName,strtok(NULL,";"));        strcpy(Students[i].Faculty,strtok(NULL,";"));        strcpy(Students[i].Spec,strtok(NULL,"\n"));        Students=(struct Student*)realloc(Students ,(i+2)*sizeof(struct Student));    }    fclose(StudentsFile);        while(Command != 0){        printf("\n--- Student Library ---\n");        printf("0 - Save and exit\n");        printf("1 - Add student\n");        printf("2 - Delete student\n");        printf("3 - Save backup\n");        printf("4 - Upload backup\n");        printf("5 - Search by surname\n");        printf("6 - Show all student's books\n");        printf("\n");        if(Command==-1){            p_err("Enter correct command");            printf("\n");        }            printf("Stud>");        scanf("%d", &Command);        int onemore = -1;// for case 1            switch (Command) {            case 0:                Students_exit(Students, LineCount);                return;                break;            case 1:                while (onemore != 0){                    printf("\n--- Add Student ---\n");                    struct Student *Students_test = Students_add(Students, LineCount);                    if(Students_test != NULL){                        Students = Students_test;                        LineCount++;                    }                    while(onemore != 1 && onemore != 0){                        printf("Enter one more student?\n1 - yes\n0 - no\n");                        scanf("%d", &onemore);                        printf("\n");                    }                }                Command = -11;                break;            case 2:                printf("\n--- Delete Student ---\n");                Students_delete(Students, LineCount);                Command=-11;                break;            case 3:                printf("\n--- Save Backup ---\n");                Students_backup_save(Students, LineCount);                Command=-11;                break;            case 4:                printf("\n--- Upload Backup ---\n");                Students = Students_backup_upload(Students, LineCount, StudentsFile);                Command=-11;                break;            case 5:                printf("\n--- Search by Surname ---\n");                Students_search(Students, LineCount);                Command=-11;                break;            case 6:                printf("\n--- Show all student's books ---\n");                Students_showall(Students, LineCount);                Command=-11;                break;            default:                Command = -1;                break;break;break;        }    }    free(Students);}